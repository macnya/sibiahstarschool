type User @fdc.table(name: "users") {
  userId: String! @fdc.primaryKey # This should be the Firebase Auth UID
  email: String! @fdc.unique
  firstName: String
  lastName: String
  role: UserRole!
  createdAt: Timestamp! @fdc.default(expression: "CURRENT_TIMESTAMP")
  updatedAt: Timestamp! @fdc.default(expression: "CURRENT_TIMESTAMP") @fdc.onUpdate(expression: "CURRENT_TIMESTAMP")

  studentProfile: StudentProfile @fdc.relationship(principalFields: ["userId"], foreignFields: ["userId"])
  parentLinksAsParent: [ParentStudentLink!] @fdc.relationship(principalFields: ["userId"], foreignFields: ["parentId"])
  parentLinksAsStudent: [ParentStudentLink!] @fdc.relationship(principalFields: ["userId"], foreignFields: ["studentId"])
  teacherAssignments: [TeacherClassAssignment!] @fdc.relationship(principalFields: ["userId"], foreignFields: ["teacherId"])
  enrollments: [Enrollment!] @fdc.relationship(principalFields: ["userId"], foreignFields: ["studentId"])
  gradesAsStudent: [Grade!] @fdc.relationship(principalFields: ["userId"], foreignFields: ["studentId"])
  gradesRecordedByTeacher: [Grade!] @fdc.relationship(principalFields: ["userId"], foreignFields: ["recordedById"])
}

enum UserRole {
  STUDENT
  PARENT
  TEACHER
  ADMIN
}

type StudentProfile @fdc.table(name: "student_profiles") {
  userId: String! @fdc.primaryKey # PK, and FK to User.userId
  # user: User! @fdc.relationship(principalFields: ["userId"], foreignFields: ["userId"], principalOnDelete: CASCADE) # This defines it as FK
  dateOfBirth: Date
  admissionDate: Date
  currentGradeLevel: String
}

type ParentStudentLink @fdc.table(
  name: "parent_student_links",
  uniqueConstraints: [{ name: "unique_parent_student", fields: ["parentId", "studentId"] }]
) {
  linkId: String! @fdc.primaryKey @fdc.default(expression: "gen_random_uuid()")
  parentId: String!
  studentId: String!
  relationshipType: String

  parent: User! @fdc.relationship(principalFields: ["parentId"], foreignFields: ["userId"])
  student: User! @fdc.relationship(principalFields: ["studentId"], foreignFields: ["userId"])
}
